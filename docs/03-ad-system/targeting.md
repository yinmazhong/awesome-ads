# 定向系统 (Targeting)

## 一句话概述

定向系统决定"广告展示给谁"，通过多维度的人群筛选和匹配，让广告触达最可能产生转化的目标用户。

---

## 定向体系全景

| 基础定向 | 兴趣行为定向 | 上下文定向 | 重定向 | 智能定向 |
|---------|------------|----------|--------|--------|
| 地域 | 兴趣标签 | 关键词 | Retarget | Lookalike |
| 年龄 | 行为标签 | 内容分类 | DMP人群 | 自动扩量 |
| 性别 | 消费能力 | 语义定向 | 排除人群 | 智能放量 |
| 设备 | 人生阶段 | 场景定向 | | |
| 网络 | 职业 | | | |
| 时段 | APP行为 | | | |

---

## 基础定向

### 地域定向

| 粒度 | 示例 | 实现方式 |
|------|------|---------|
| **国家** | 中国、美国 | IP 库 |
| **省份** | 广东省、浙江省 | IP 库 |
| **城市** | 上海、深圳 | IP 库 + GPS |
| **区县** | 浦东新区 | GPS |
| **商圈** | 陆家嘴3公里内 | GPS + POI |
| **自定义区域** | 地图画圈 | GPS + 地理围栏 |

**技术实现**:
- IP → 地域: MaxMind GeoIP / 纯真IP库
- GPS 定位: 客户端 SDK 获取经纬度
- WiFi 定位: WiFi 热点 → 位置映射
- 基站定位: 运营商基站 → 粗略位置

### 人口属性定向

| 属性 | 来源 | 准确度 |
|------|------|--------|
| **年龄** | 注册信息 / 模型预测 | 注册信息高，预测中等 |
| **性别** | 注册信息 / 模型预测 | 注册信息高，预测较高 |
| **学历** | 注册信息 / 行为推断 | 低 |
| **婚姻状态** | 行为推断 | 低 |
| **消费能力** | 消费行为分析 | 中等 |

### 设备定向

| 维度 | 选项 |
|------|------|
| **操作系统** | iOS / Android |
| **设备品牌** | Apple / 华为 / 小米 / OPPO / vivo |
| **设备价格** | 高端 (>¥5000) / 中端 / 低端 |
| **网络类型** | WiFi / 4G / 5G |
| **运营商** | 移动 / 联通 / 电信 |

### 时段定向

投放时段设置示例：7:00 - 22:00 投放

| 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| | | | | | | | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | | |

---

## 兴趣行为定向

### 兴趣标签体系

```
一级分类 (20+)
├── 美妆护肤
│   ├── 护肤品 (二级)
│   │   ├── 面膜 (三级)
│   │   ├── 精华
│   │   └── 防晒
│   ├── 彩妆
│   └── 美容仪器
├── 汽车
│   ├── 新能源汽车
│   ├── 豪华车
│   └── SUV
├── 游戏
│   ├── 手游
│   ├── 端游
│   └── 主机游戏
└── ... (教育/金融/旅游/母婴/体育/...)
```

### 兴趣标签来源

| 来源 | 说明 | 时效性 |
|------|------|--------|
| **浏览行为** | 用户浏览的内容类别 | 实时/近期 |
| **搜索行为** | 用户搜索的关键词 | 实时/近期 |
| **互动行为** | 点赞、评论、收藏、分享 | 近期 |
| **消费行为** | 购买记录、支付行为 | 中长期 |
| **App 使用** | 安装和使用的 App | 中长期 |
| **注册信息** | 用户主动填写 | 长期 |

### 行为定向

| 行为类型 | 示例 | 应用场景 |
|---------|------|---------|
| **电商行为** | 浏览商品、加购、下单 | 电商广告定向 |
| **App 行为** | 安装、激活、使用时长 | App 推广定向 |
| **内容消费** | 阅读、观看、搜索 | 兴趣定向 |
| **线下行为** | 到店、出行轨迹 | LBS 广告 |
| **转化行为** | 注册、付费、复购 | 排除已转化用户 |

---

## 上下文定向

### 关键词定向

```
搜索广告:
  用户搜索 "北京二手房" → 匹配关键词 → 展示房产广告

信息流广告:
  用户正在阅读"装修攻略"文章 → 提取关键词 → 展示家装广告
```

**匹配类型** (搜索广告):

| 类型 | 示例 | 触发查询 |
|------|------|---------|
| **精确匹配** | [红色跑鞋] | 红色跑鞋 |
| **短语匹配** | "红色跑鞋" | 红色跑鞋推荐、买红色跑鞋 |
| **广泛匹配** | 红色跑鞋 | 运动鞋、跑步装备 |

### 内容分类定向

```
页面/视频内容 → NLP/CV 分类 → 内容标签
  "iPhone 16 评测视频" → [科技, 手机, Apple]
  → 匹配定向到"科技"类别的广告
```

### 语义定向

- 基于 NLP 理解页面语义，而非简单关键词匹配
- 大模型时代: 使用 LLM 理解内容深层语义
- 优势: 更精准，避免关键词歧义

---

## 重定向 (Retargeting)

### 定义
对已经与品牌/产品有过交互的用户再次展示广告，提升转化率。

### 重定向类型

| 类型 | 说明 | 示例 |
|------|------|------|
| **网站重定向** | 访问过网站的用户 | 浏览过商品但未购买 |
| **搜索重定向** | 搜索过相关关键词 | 搜索过"保险"的用户 |
| **App 重定向** | App 内行为用户 | 加购未支付的用户 |
| **CRM 重定向** | 广告主自有客户数据 | 老客户召回 |
| **动态重定向** | 展示用户浏览过的具体商品 | 电商个性化推荐广告 |

### 动态重定向 (Dynamic Retargeting)

用户行为:
  1. 浏览了 Nike Air Max (红色, 42码)
  2. 浏览了 Adidas Ultraboost
  3. 加购了 Nike Air Max，未支付

重定向广告示例:

> **您浏览过的商品**
>
> | Nike Air Max | Adidas Ultraboost |
> |:---:|:---:|
> | ¥899 | ¥999 |
>
> **[立即购买]**

---

## 智能定向

### Lookalike (相似人群扩展)

```
输入: 种子人群 (如: 已付费用户 10,000 人)
输出: 相似人群 (扩展到 1,000,000 人)

流程:
1. 分析种子人群的特征分布
2. 在全量用户中找到特征相似的用户
3. 按相似度排序，取 Top-N

算法:
  - 特征相似度 (Cosine Similarity)
  - 分类模型 (LR/XGBoost)
  - Embedding 相似度 (Deep Learning)

扩展比例:
  1:10  → 精准但量小
  1:50  → 平衡
  1:100 → 量大但精准度下降
```

### 自动扩量 / 智能放量

```
广告主设定基础定向 → 平台自动扩展到更大人群

原理:
  基础定向: 25-35岁女性，美妆兴趣 (100万人)
  智能放量: 算法发现 36-40岁女性也有高转化率
           → 自动扩展到该人群 (300万人)

控制:
  - 广告主可设定扩展范围
  - 平台保证扩展后的 CPA 不高于目标
```

### 系统推荐定向

- 平台基于广告主的行业、产品、历史数据，自动推荐定向组合
- 趋势: 定向越来越自动化，广告主只需设定目标

---

## 定向的技术实现

### 倒排索引

```
正排: 广告 → 定向条件
  广告A: {地域: 上海, 年龄: 25-35, 性别: 女}
  广告B: {地域: 北京, 年龄: 18-24, 兴趣: 游戏}

倒排: 定向条件 → 广告列表
  地域=上海:  [广告A, 广告C, 广告E, ...]
  年龄=25-35: [广告A, 广告D, 广告F, ...]
  性别=女:    [广告A, 广告G, 广告H, ...]

查询: 用户(上海, 28岁, 女)
  → 取交集: {广告A} ∩ {广告A, 广告D} ∩ {广告A, 广告G}
  → 结果: {广告A}
```

### 布尔表达式引擎

```
定向条件表达为布尔表达式:
  (地域 IN [上海, 北京]) AND (年龄 BETWEEN 25 AND 35) AND (性别 = 女)

优化:
  - 短路求值: 先评估过滤性强的条件
  - 位图索引: 用 Bitmap 加速集合运算
  - 预编译: 将表达式编译为高效的执行计划
```

### 人群包 (Audience Package)

```
DMP 人群包:
  1. 广告主上传用户ID列表 (手机号/DeviceID)
  2. 平台匹配到内部用户ID
  3. 投放时检查用户是否在人群包中

技术:
  - 小人群包: HashSet 内存存储
  - 大人群包: Bloom Filter 近似匹配
  - 超大人群包: 分布式 Bitmap
```

---

## 定向策略最佳实践

### 定向宽窄的权衡

```
定向太窄:
  ✓ 精准度高
  ✗ 覆盖人群少，量级不足
  ✗ eCPM 竞争激烈，成本高

定向太宽:
  ✓ 覆盖人群大，量级充足
  ✗ 精准度低，转化率差
  ✗ 预算浪费

最佳实践:
  1. 先宽后窄: 初期宽定向积累数据，再逐步收窄
  2. 分层测试: 核心人群 + 扩展人群分计划测试
  3. 信任算法: 使用智能放量，让平台算法优化
```

### 排除定向

```
常见排除策略:
  - 排除已转化用户 (避免重复获客)
  - 排除已安装用户 (App 推广)
  - 排除竞品用户 (品牌保护)
  - 排除低质量用户 (薅羊毛用户)
```

---

## 与大数据开发的关联

- **标签计算**: 用户兴趣/行为标签的离线和实时计算
- **人群包管理**: 人群包的上传、匹配、存储、更新
- **Lookalike 数据**: 种子人群特征提取和相似度计算
- **定向索引构建**: 倒排索引的离线构建和在线更新
- **IP 库维护**: IP 地域映射库的更新和维护
- **定向效果分析**: 不同定向组合的效果分析报表

---

## 面试高频问题

1. 广告定向有哪些维度？各自的实现原理？
2. Lookalike 扩量的原理是什么？
3. 重定向 (Retargeting) 是如何实现的？
4. 定向系统的技术实现方案？(倒排索引、布尔表达式)
5. 定向太窄和太宽分别有什么问题？如何平衡？

---

## 推荐阅读

- 《计算广告》第 10 章 — 受众定向
- [Facebook Lookalike Audiences 文档](https://www.facebook.com/business/)
- [巨量引擎定向指南](https://www.oceanengine.com/)
